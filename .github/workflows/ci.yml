# Nombre del pipeline que se mostrará en la interfaz de GitHub Actions.
name: 'CI Pipeline: .NET MAUI y ASP.NET Core'

# --- Disparador (Trigger) ---
# El workflow se activará con cada push a la rama 'develop'.
on:
  push:
    branches:
      - develop

# --- Definición de los Jobs (Tareas) ---
jobs:
  # Job para el Backend (ASP.NET Core)
  build-and-test-backend:
    name: 'Backend: Build & Test'
    # Usamos una máquina virtual Ubuntu, ideal y rápida para APIs de .NET.
    runs-on: ubuntu-latest
    
    # --- Configuración del contenedor de servicio para PostgreSQL ---
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: 'Checkout del código'
        uses: actions/checkout@v4

      - name: 'Configurar entorno .NET 8'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # --- Compilación (Build) ---
      # Justificación: Restauramos las dependencias del proyecto de PRUEBAS.
      # Esto es clave, ya que restaurará sus propias dependencias (xUnit) y las del proyecto que referencia (Backend).
      - name: 'Restaurar dependencias del Backend'
        run: dotnet restore Backend/Backend.Tests/Backend.Tests.csproj
        
      # Justificación: Compilamos el proyecto de pruebas, lo que a su vez fuerza la compilación del proyecto principal.
      - name: 'Compilar Backend (Build)'
        run: dotnet build Backend/Backend.Tests/Backend.Tests.csproj --configuration Release --no-restore

      # --- Pruebas (Test) ---
      # Justificación: Ejecutamos las pruebas unitarias y de integración del backend.
      - name: 'Ejecutar Pruebas del Backend'
        run: dotnet test Backend/Backend.Tests/Backend.Tests.csproj --configuration Release --no-build --verbosity normal
        env:
          ConnectionStrings__TestDb: "Host=localhost;Port=5432;Username=postgres;Password=postgres_password;Database=test_db"

  # Job para el Frontend (.NET MAUI)
  build-and-test-frontend:
    name: 'Frontend: Build & Test'
    # Justificación: .NET MAUI necesita un entorno Windows para compilar para Android/iOS.
    runs-on: windows-latest
    
    steps:
      - name: 'Checkout del código'
        uses: actions/checkout@v4

      - name: 'Configurar entorno .NET 8'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          
      # --- PASO NUEVO Y CLAVE ---
      # Justificación: Instalamos las "workloads" de .NET MAUI en el runner de Windows.
      # Este comando lee los archivos .csproj e instala automáticamente las herramientas necesarias para compilar.
      - name: 'Instalar .NET MAUI Workloads'
        run: dotnet workload restore

      # --- Compilación (Build) ---
      # Justificación: Restauramos las dependencias del proyecto de pruebas del frontend.
      - name: 'Restaurar dependencias del Frontend'
        run: dotnet restore Frontend/Frontend.Tests/Frontend.Tests.csproj
        
      # Justificación: Compilamos el proyecto MAUI para Android para validar la lógica y la UI.
      - name: 'Compilar Frontend para Android (Build)'
        run: dotnet build Frontend/Frontend.csproj -f net8.0-android -c Release --no-restore

      # --- Pruebas (Test) ---
      # Justificación: Ejecutamos las pruebas unitarias del proyecto MAUI.
      - name: 'Ejecutar Pruebas del Frontend'
        run: dotnet test Frontend/Frontend.Tests/Frontend.Tests.csproj --configuration Release --no-build --verbosity normal