# Nombre del pipeline que se mostrará en la interfaz de GitHub Actions.
name: 'CI Pipeline: Backend'

# --- Disparador (Trigger) ---
# El workflow se activará con cada push a las ramas 'main' y 'develop'.
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# --- Definición de los Jobs (Tareas) ---
jobs:
  # Job para el Backend (ASP.NET Core)
  build-and-test-backend:
    name: 'Backend: Build & Test'
    runs-on: ubuntu-latest # Usamos la última versión de Ubuntu para el runner

    steps:
      # Paso 1: Descargar el código del repositorio
      - name: 'Checkout del código'
        uses: actions/checkout@v4

      # Paso 2: Configurar el entorno .NET 8
      - name: 'Configurar entorno .NET 8'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # Paso 3: Restaurar las dependencias de toda la solución
      # Es mejor restaurar la solución completa para asegurar que todos los proyectos se resuelvan correctamente.
      - name: 'Restaurar dependencias'
        run: dotnet restore ciudad-conectada.sln
        
      # Paso 4: Compilar toda la solución
      # Compilamos la solución en modo Release para asegurarnos de que no hay errores de compilación.
      - name: 'Compilar solución (Build)'
        run: dotnet build ciudad-conectada.sln --configuration Release --no-restore

      # Paso 5: Ejecutar las pruebas del Backend
      # Ejecutamos las pruebas. El CustomWebApplicationFactory usará la BD en memoria,
      # por lo que no necesitamos configurar una base de datos PostgreSQL real aquí.
      - name: 'Ejecutar Pruebas del Backend'
        run: dotnet test Backend.Tests/Backend.Tests.csproj --configuration Release --no-build --verbosity normal
  
  deploy-backend:
      name: 'Deploy en Render'
      runs-on: ubuntu-latest

      #ESTE JOB SOLO SE EJECUTA SI EL ANTERIOR FUE EXITOSO
      needs: build-and-test-backend

      # SOLO DESPLIEGA SI ES PUSH A MAIN
      if: github.ref == 'refs/heads/main'

      steps:
        - name: 'Desplegar en Render'
          run: |
            curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
